<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/websocket.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/websocket.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { EventEmitter } from "events"
import { WebSocket as WsClient } from "ws"
import("../types/websocket.types.js")

/**
 * @namespace
 * @extends EventEmitter
 */
export class Websocket extends EventEmitter {

    // for subscribing
    wsTopics = new Map()

    // for connecting
    wsLists = new Map()

    /**
     * @param {Constructor} options
     */
    constructor(options = {}) {
        super()
        this.api_key        = options.api_key
        this.api_secret     = options.api_secret
        this.wsBaseURL      = options.wsBaseURL
        this.wsBaseURLTest  = options.wsBaseURLTest
        this.wsAuthURL      = options.wsAuthURL
        this.isTestNet      = options.isTestNet
        this.reconnectSleep = options.reconnectSleep

        // Default
        if (!this.reconnectSleep) {
            this.reconnectSleep = 3000
        }
    }
    
    // ######################################## Overwrite addListener &amp; on JSDoc
    /**
     * @typedef WsApiOptions
     * @property {String} api_key
     * @property {String} api_secret
     */

    /**
     * @callback WS
     * @param {WsClient} socket
     * @param {WsApiOptions} options
     */

    /**
     * @param {"USER_DATA" | "DATA"} eventName or anything else
     * @param {WS} callback
     */
     addListener(eventName, callback) {
        super.addListener(eventName, callback)
    }

    /**
     * @param {"USER_DATA" | "DATA"} eventName or anything else
     * @param {WS} callback
     */
    on(eventName, callback) {
        super.on(eventName, callback)
    }
    // ############################################

    /**
     * @param {Number} ms milliseconds
     */
    async sleep(ms) {
        try {
            return new Promise(resolve => setTimeout(resolve, ms))
        } catch {}
    }

    /**
     * @param {Number} wsID Example: 311
     */
    unsubscribe(wsID) {
        let topic = this.wsTopics.get(wsID)

        if (topic) {
            
            let ws      = topic.ws
            let request = topic.request

            console.log(`Unsubscribe to ${request.params}`)
            
            request.method = "UNSUBSCRIBE"

            ws.send(JSON.stringify(request))
            ws.close(1000, `Unsubscribed: ${request.params}`)
            this.wsTopics.delete(wsID)
        }
    }
    
    /**
     * 
     * @param {Array&lt;String>} params Example: ["btcusdt@kline_1m", "etcusdt@kline_3m"]
     * @param {Number} id Example: 316
     * @param {"DATA"} eventName Example: "BTC" or anything else
     */
    subscribe(params, id, eventName="DATA") {
        let URL = this.wsBaseURL
        if (this.isTestNet) {
            console.log("## Websocket: Test Net ##")
            URL = this.wsBaseURLTest
        }

        let ws = new WsClient(URL + "/ws")

        let request = {
            method: "SUBSCRIBE",
            params,
            id,
        }

        ws.on("ping", (data) => {
            ws.ping()
            ws.pong()
        })

        ws.on("open", (event) => {

            console.log(`Subscribed to ${request.params}`)

            // Ask binance for subscription
            ws.send(JSON.stringify(request))

            // Add to subscribe list
            this.wsTopics.set(request.id, { ws, request })

            this.emit(eventName, ws, {
                api_key: this.api_key,
                api_secret: this.api_secret,
            })
        })

        ws.on("close", (code, reason) => {
            console.log(`Websocket Closed - Code: ${code} - Reason: ${reason}`)
            
            let wsReference = this.wsTopics.get(request.id)
            if (wsReference) {
                console.log(`Reconnecting after ${this.reconnectSleep} ms`)
                this.sleep(this.reconnectSleep).then(() => {
                    this.subscribe(params, request.id, eventName)
                })
            }
        })

        ws.on("error", (error) => console.log("Error Happens", error))
    }

    /**
     * @param {String} path Example: "/ws/bnbusdt@aggTrade"
     */
    disconnect(path) {
        let wsRef = this.wsLists.get(path)
        if (wsRef.ws) {
            let ws = wsRef.ws
            ws.close()
            this.wsLists.delete(path)
        }
    }

    /**
     * @param {String} path Example: "/ws/bnbusdt@aggTrade"
     * @param {String} eventName Example: "BTC" or anything else
     */
    connect(path, eventName="DATA") {

        let URL = this.wsBaseURL
        if (this.isTestNet) {
            console.log("## Websocket: Test Net ##")
            URL = this.wsBaseURLTest
        }

        let ws = new WsClient(URL + path)

        ws.on("open", (event) => {
            console.log(`Connection Opened for: ${path}`)

            // Add to connection list
            this.wsLists.set(path, {ws, eventName})
            
            this.emit(eventName, ws, {
                api_key: this.api_key,
                api_secret: this.api_secret,
            })
        })
        
        ws.on("close", (code, reason) => {
            console.log(`Connection closed for: ${path} - Code: ${code} - Reason: ${reason}`)

            let wsReference = this.wsLists.get(path)
            if (wsReference) {
                console.log(`Reconnecting after ${this.reconnectSleep} ms`)
                this.sleep(this.reconnectSleep).then(() => {
                    this.connect(path, eventName)
                })
            }
        })

        ws.on("error", (error) => console.log("Error Happens", error))
    }

    /**
     * @param {String} listenKey
     * @param {"USER_DATA"} eventName Example: USER_DATA or anything else
     */
    async userStream(listenKey, eventName) {
        let path = "/ws/" + listenKey
        this.connect(path, eventName)
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="BlvtStream.html">BlvtStream</a></li><li><a href="CoinM.html">CoinM</a></li><li><a href="EuOptions.html">EuOptions</a></li><li><a href="Futures.html">Futures</a></li><li><a href="Http.html">Http</a></li><li><a href="Spot.html">Spot</a></li><li><a href="Websocket_.html">Websocket</a></li></ul><h3>Classes</h3><ul><li><a href="CloseEvent.html">CloseEvent</a></li><li><a href="ErrorEvent.html">ErrorEvent</a></li><li><a href="Event.html">Event</a></li><li><a href="Limiter.html">Limiter</a></li><li><a href="MessageEvent.html">MessageEvent</a></li><li><a href="PerMessageDeflate.html">PerMessageDeflate</a></li><li><a href="Receiver.html">Receiver</a></li><li><a href="Sender.html">Sender</a></li><li><a href="WebSocket.html">WebSocket</a></li><li><a href="WebSocketServer.html">WebSocketServer</a></li></ul><h3>Mixins</h3><ul><li><a href="EventTarget.html">EventTarget</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_append">_append</a></li><li><a href="global.html#_createHelper">_createHelper</a></li><li><a href="global.html#_createHmacHelper">_createHmacHelper</a></li><li><a href="global.html#_isValidUTF8">_isValidUTF8</a></li><li><a href="global.html#_mask">_mask</a></li><li><a href="global.html#_parse">_parse</a></li><li><a href="global.html#_process">_process</a></li><li><a href="global.html#_unmask">_unmask</a></li><li><a href="global.html#cfg">cfg</a></li><li><a href="global.html#clamp">clamp</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#compute">compute</a></li><li><a href="global.html#concat">concat</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#createDecryptor">createDecryptor</a></li><li><a href="global.html#createEncryptor">createEncryptor</a></li><li><a href="global.html#createWebSocketStream">createWebSocketStream</a></li><li><a href="global.html#decrypt">decrypt</a></li><li><a href="global.html#encrypt">encrypt</a></li><li><a href="global.html#extend">extend</a></li><li><a href="global.html#finalize">finalize</a></li><li><a href="global.html#format">format</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#isValidStatusCode">isValidStatusCode</a></li><li><a href="global.html#mixIn">mixIn</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#process">process</a></li><li><a href="global.html#processBlock">processBlock</a></li><li><a href="global.html#random">random</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#toArrayBuffer">toArrayBuffer</a></li><li><a href="global.html#toBuffer">toBuffer</a></li><li><a href="global.html#toString">toString</a></li><li><a href="global.html#toX32">toX32</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Thu Dec 01 2022 10:14:16 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
